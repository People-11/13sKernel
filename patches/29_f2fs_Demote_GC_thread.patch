From d5c349f65bad3c9edea29522b5d7462e80d9aa32 Mon Sep 17 00:00:00 2001
From: brokestar233 <3765589194@qq.com>
Date: Sat, 6 Sep 2025 02:35:11 +0800
Subject: [PATCH] f2fs: Demote GC thread to idle scheduler class

We don't want the background GC work causing UI jitter should it ever
collide with periods of user activity.

Signed-off-by: brokestar233 <3765589194@qq.com>
---
 fs/f2fs/gc.c | 3 +++
 1 file changed, 3 insertions(+)

Index: common/fs/f2fs/gc.c
===================================================================
--- common/fs/f2fs/gc.c	2025-10-14 12:24:36.138195424 +1030
+++ common/fs/f2fs/gc.c	2025-10-14 12:24:36.134254448 +1030
@@ -13,6 +13,7 @@
 #include <linux/delay.h>
 #include <linux/freezer.h>
 #include <linux/sched/signal.h>
+#include <uapi/linux/sched/types.h>
 #include <linux/random.h>
 #include <linux/sched/mm.h>
 
@@ -188,6 +189,7 @@
 
 int f2fs_start_gc_thread(struct f2fs_sb_info *sbi)
 {
+	const struct sched_param param = { .sched_priority = 0 };
 	struct f2fs_gc_kthread *gc_th;
 	dev_t dev = sbi->sb->s_bdev->bd_dev;
 
@@ -226,6 +228,7 @@
 		sbi->gc_thread = NULL;
 		return err;
 	}
+	sched_setscheduler(sbi->gc_thread->f2fs_gc_task, SCHED_IDLE, &param);
 	set_task_ioprio(sbi->gc_thread->f2fs_gc_task,
 		IOPRIO_PRIO_VALUE(IOPRIO_CLASS_IDLE, 0));
 	return 0;
